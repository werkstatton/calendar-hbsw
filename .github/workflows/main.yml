# Whenever a tag push matching pattern "v*" then run the job
on:
  push:
    branches:
    - main
    - release/*

jobs:
  # job id, can be anything
  export_game:
    # Always use ubuntu-latest for this action
    runs-on: ubuntu-latest
    # Add permission for release creation. Can be made narrower according to your needs
    permissions: write-all
    # Job name, can be anything
    name: Export Game
    steps:
      # Always include the checkout step so that 
      # your project is available for Godot to export
    - name: checkout
      uses: actions/checkout@v4

    - name: Start Xvfb
      run: |
        sudo apt-get update
        sudo apt-get install -y xvfb
        Xvfb :99 & export DISPLAY=:99
  
    - name: Build Godot
      # You may pin to the exact commit or the version.
      # uses: yeslayla/build-godot-action@11589640849ce5bd1bab945c694bb418cb06cb15
      uses: yeslayla/build-godot-action@v1.4.1
      id: export
      with:
        # Name of the exported binary
        name: switch
        # Name of the preset in `export_presets.cfg` to use
        preset: 'Nintendo Switch'
        # Optional name of the subdirectory to put exported project in
        subdirectory: 'releases'
        # Set true to output an artifact zip file
        package: true
        # Location of Godot project in repository
        projectDir: ./src
        # Whether or not to use `--export-debug`
        debugMode: false

      # This release action has worked well for me. However, you can most likely use any release action of your choosing.
      # https://github.com/ncipollo/release-action
    - name: create release
      uses: ncipollo/release-action@v1.14.0
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        generateReleaseNotes: true
        tag: ${{ github.ref_name }}
        artifacts: ${{ steps.export.outputs.build }}/*
